name: Reusable Bluesky Post

on:
  workflow_call:
    inputs:
      post_file:
        description: 'Path to the blog post file'
        required: true
        type: string
      custom_message:
        description: 'Custom message to post (optional)'
        required: false
        type: string
      force_update:
        description: 'Force update even if blueskyPostURI exists'
        required: false
        type: boolean
        default: false
    secrets:
      BSKY_IDENTIFIER:
        required: true
      BSKY_PASSWORD:
        required: true
      GITHUB_TOKEN:
        required: true
    outputs:
      posted:
        description: 'Whether a post was made'
        value: ${{ jobs.bluesky-post.outputs.posted }}
      bluesky_uri:
        description: 'The Bluesky post URI'
        value: ${{ jobs.bluesky-post.outputs.bluesky_uri }}
      bluesky_url:
        description: 'The Bluesky post URL'
        value: ${{ jobs.bluesky-post.outputs.bluesky_url }}

permissions:
  contents: write

jobs:
  bluesky-post:
    name: Post to Bluesky
    runs-on: ubuntu-latest
    outputs:
      posted: ${{ steps.bluesky-post.outputs.posted }}
      bluesky_uri: ${{ steps.bluesky-post.outputs.uri }}
      bluesky_url: ${{ steps.bluesky-post.outputs.url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Process post and generate message
        id: process-post
        env:
          POST_FILE: ${{ inputs.post_file }}
          CUSTOM_MESSAGE: ${{ inputs.custom_message }}
          FORCE_UPDATE: ${{ inputs.force_update }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if file exists
          if [ ! -f "$POST_FILE" ]; then
            echo "Error: File $POST_FILE not found"
            exit 1
          fi

          # Check if already has Bluesky URI and force_update is false
          if [ "$FORCE_UPDATE" != "true" ]; then
            FRONTMATTER=$(awk '/^---$/{if(seen){exit} seen=1; next} seen{print}' "$POST_FILE")
            if echo "$FRONTMATTER" | grep -q "blueskyPostURI:"; then
              echo "Post already has blueskyPostURI. Skipping."
              echo "SKIP_POST=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          echo "Processing file: $POST_FILE"

          # Extract post metadata
          POST_TITLE=$(grep "^title:" "$POST_FILE" | sed 's/title: *//; s/^"\(.*\)"$/\1/')
          POST_DESCRIPTION=$(grep "^description:" "$POST_FILE" | sed 's/description: *//; s/^"\(.*\)"$/\1/')
          POST_CATEGORY=$(grep "^category:" "$POST_FILE" | sed 's/category: *//')

          # Generate URL
          ENCODED_TITLE=$(echo "$POST_TITLE" | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | sed 's/--*/-/g')
          POST_URL="https://rawlinson.us/${POST_CATEGORY}/${ENCODED_TITLE}/"

          echo "Post title: $POST_TITLE"
          echo "Post URL: $POST_URL"

          # Use custom message or generate with AI
          if [ ! -z "$CUSTOM_MESSAGE" ]; then
            BLUESKY_TEXT="$CUSTOM_MESSAGE $POST_URL"
            echo "Using custom message"
          else
            echo "Generating AI message..."

            # Extract content preview
            POST_CONTENT=$(awk '
              BEGIN { in_frontmatter = 0; content_started = 0; }
              /^---$/ {
                if (in_frontmatter == 1) { content_started = 1; }
                in_frontmatter = !in_frontmatter;
                next;
              }
              content_started == 1 && in_frontmatter == 0 {
                if (NF == 0 && length(content) == 0) next;
                gsub(/^#+\s*/, "");
                gsub(/\[([^\]]*)\]\([^\)]*\)/, "\\1");
                gsub(/\*\*([^\*]*)\*\*/, "\\1");
                gsub(/\*([^\*]*)\*/, "\\1");
                content = content " " $0;
                if (length(content) > 500) exit;
              }
              END { print substr(content, 1, 500); }
            ' "$POST_FILE")

            # Generate message with AI
            PROMPT="Write a short, engaging social media post (under 225 characters) for a blog post. Use US english, never use emdash and only use hashtags sparingly. Title: $POST_TITLE. Description: $POST_DESCRIPTION. Category: $POST_CATEGORY. Content preview: $POST_CONTENT. Make it conversational. Don't include the URL."

            AI_RESPONSE=$(curl -s "https://models.github.ai/inference/chat/completions" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -d "{
                \"messages\": [
                  {
                    \"role\": \"user\",
                    \"content\": $(echo "$PROMPT" | jq -R -s .)
                  }
                ],
                \"model\": \"openai/gpt-4.1\"
              }")

            AI_MESSAGE=$(echo "$AI_RESPONSE" | jq -r '.choices[0].message.content')
            BLUESKY_TEXT="${AI_MESSAGE} ${POST_URL}"
          fi

          echo "Generated message: $BLUESKY_TEXT"

          # Set outputs
          echo "BLUESKY_TEXT=$BLUESKY_TEXT" >> $GITHUB_OUTPUT
          echo "POST_FILE=$POST_FILE" >> $GITHUB_OUTPUT
          echo "SKIP_POST=false" >> $GITHUB_OUTPUT

      - name: Post to Bluesky
        if: steps.process-post.outputs.SKIP_POST != 'true' && steps.process-post.outputs.BLUESKY_TEXT != ''
        id: bluesky-post
        run: |
          # Install AT Protocol client and GitHub Actions core
          npm install @atproto/api @actions/core

          # Create Node.js script for posting
          cat > post_to_bluesky.js << 'EOF'
          const { BskyAgent, RichText } = require('@atproto/api');
          const core = require('@actions/core');

          async function main() {
            const agent = new BskyAgent({
              service: 'https://bsky.social'
            });

            try {
              await agent.login({
                identifier: process.env.BSKY_IDENTIFIER,
                password: process.env.BSKY_PASSWORD
              });

              const richText = new RichText({
                text: process.env.POST_TEXT
              });

              await richText.detectFacets(agent);

              const response = await agent.post({
                text: richText.text,
                facets: richText.facets,
                createdAt: new Date().toISOString()
              });

              console.log('Post successful!');
              console.log('URI:', response.uri);
              console.log('CID:', response.cid);

              core.setOutput('uri', response.uri);
              core.setOutput('cid', response.cid);
              core.setOutput('posted', 'true');

              const identifier = process.env.BSKY_IDENTIFIER || '';
              const username = identifier.startsWith('@') ? identifier.slice(1) : identifier;
              const postId = response.uri.split('/').pop();
              const url = `https://bsky.app/profile/${username}/post/${postId}`;

              core.setOutput('url', url);
              console.log('Post URL:', url);

            } catch (error) {
              console.error('Error posting to Bluesky:', error);
              core.setOutput('posted', 'false');
              process.exit(1);
            }
          }

          main();
          EOF

          node post_to_bluesky.js
        env:
          BSKY_IDENTIFIER: ${{ secrets.BSKY_IDENTIFIER }}
          BSKY_PASSWORD: ${{ secrets.BSKY_PASSWORD }}
          POST_TEXT: ${{ steps.process-post.outputs.BLUESKY_TEXT }}

      - name: Update post with Bluesky URI
        if: steps.bluesky-post.outputs.posted == 'true'
        run: |
          POST_FILE="${{ steps.process-post.outputs.POST_FILE }}"

          # Add or update blueskyPostURI in frontmatter
          if grep -q "blueskyPostURI:" "$POST_FILE"; then
            # Update existing URI
            sed -i "s|blueskyPostURI:.*|blueskyPostURI: \"${{ steps.bluesky-post.outputs.uri }}\"|" "$POST_FILE"
            echo "Updated existing blueskyPostURI in $POST_FILE"
          else
            # Add new URI after firstprop line
            sed -i "/^firstprop: first$/a blueskyPostURI: \"${{ steps.bluesky-post.outputs.uri }}\"" "$POST_FILE"
            echo "Added blueskyPostURI to $POST_FILE"
          fi

      - name: Commit changes
        if: steps.bluesky-post.outputs.posted == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add "${{ steps.process-post.outputs.POST_FILE }}"
          git diff --staged --quiet || git commit -m "Add Bluesky post URI to ${{ steps.process-post.outputs.POST_FILE }}"
          git push

      - name: Summary
        if: steps.bluesky-post.outputs.posted == 'true'
        run: |
          echo "âœ… Successfully posted to Bluesky!"
          echo "ðŸ“ Post: ${{ steps.process-post.outputs.POST_FILE }}"
          echo "ðŸ”— Bluesky URL: ${{ steps.bluesky-post.outputs.url }}"
          echo "ðŸ†” URI: ${{ steps.bluesky-post.outputs.uri }}"