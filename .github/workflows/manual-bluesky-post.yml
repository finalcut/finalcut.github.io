name: Manual Bluesky Post

on:
  workflow_dispatch:
    inputs:
      post_file:
        description: 'Blog post filename (e.g., 2025-11-10-my-blog-post.md)'
        required: true
        type: string
      custom_message:
        description: 'Optional custom message (if empty, will generate one with AI)'
        required: false
        type: string
      force_repost:
        description: 'Force repost even if blueskyPostURI already exists'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  models: read

jobs:
  post-to-bluesky:
    name: Post to Bluesky
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract post content and prepare message
        id: prepare
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Install jq for JSON processing
          sudo apt-get update && sudo apt-get install -y jq

          POST_PATH="_posts/${{ github.event.inputs.post_file }}"

          if [ ! -f "$POST_PATH" ]; then
            echo "Error: Post file $POST_PATH not found"
            exit 1
          fi

          # Extract title and excerpt for message generation
          TITLE=$(grep "^title:" "$POST_PATH" | sed 's/^title: *//; s/^["'\'']*//; s/["'\'']*$//')
          EXCERPT=$(grep "^excerpt:" "$POST_PATH" | sed 's/^excerpt: *//; s/^["'\'']*//; s/["'\'']*$//')
          DESCRIPTION=$(grep "^description:" "$POST_PATH" | sed 's/description: *//; s/^"\(.*\)"$/\1/')
          CATEGORY=$(grep "^category:" "$POST_PATH" | sed 's/category: *//')

          # Extract post content for context
          POST_CONTENT=$(awk '
            BEGIN { in_frontmatter = 0; content_started = 0; }
            /^---$/ {
              if (in_frontmatter == 1) { content_started = 1; }
              in_frontmatter = !in_frontmatter;
              next;
            }
            content_started == 1 && in_frontmatter == 0 {
              if (NF == 0 && length(content) == 0) next;
              gsub(/^#+\s*/, "");
              gsub(/\[([^\]]*)\]\([^\)]*\)/, "\\1");
              gsub(/\*\*([^\*]*)\*\*/, "\\1");
              gsub(/\*([^\*]*)\*/, "\\1");
              content = content " " $0;
              if (length(content) > 500) exit;
            }
            END { print substr(content, 1, 500); }
          ' "$POST_PATH")

          # Get the post URL
          FILENAME=$(basename "${{ github.event.inputs.post_file }}" .md)
          DATE_PART=$(echo "$FILENAME" | grep -o '^[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}')
          URL_PART=$(echo "$FILENAME" | sed "s/^$DATE_PART-//")
          POST_URL="https://finalcut.github.io/blogging/$URL_PART/"

          if [ -n "${{ github.event.inputs.custom_message }}" ]; then
            MESSAGE="${{ github.event.inputs.custom_message }} $POST_URL"
            echo "Using custom message with URL"
          else
            echo "Generating AI message"
            # Create enhanced prompt with post context
            PROMPT="Write a short, engaging social media post (under 225 characters) for a new blog post. Use US english, never use emdash and only use hashtags sparingly and if they fit into the body of the text in a way that reads like a sentence. Title: $TITLE. Description: $DESCRIPTION. Category: $CATEGORY. Content preview: $POST_CONTENT. Make it conversational and include relevant hashtags. Don't include the URL."

            AI_RESPONSE=$(curl -s "https://models.github.ai/inference/chat/completions" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -d "{
                \"messages\": [
                  {
                    \"role\": \"user\",
                    \"content\": $(echo "$PROMPT" | jq -R -s .)
                  }
                ],
                \"model\": \"openai/gpt-4.1\"
              }")

            echo "AI response: $AI_RESPONSE"

            # Extract the message from the response
            AI_MESSAGE=$(echo "$AI_RESPONSE" | jq -r '.choices[0].message.content')
            MESSAGE="${AI_MESSAGE} ${POST_URL}"
          fi

          echo "MESSAGE=$MESSAGE" >> $GITHUB_OUTPUT
          echo "Generated message: $MESSAGE"

      - name: Post to Bluesky
        id: bluesky
        uses: finalcut/bluesky-post-action@feature/add-post-outputs
        env:
          BSKY_IDENTIFIER: ${{ secrets.BLUESKY_IDENTIFIER }}
          BSKY_PASSWORD: ${{ secrets.BLUESKY_PASSWORD }}
        with:
          post: ${{ steps.prepare.outputs.MESSAGE }}
          service: https://bsky.social

      - name: Update post with Bluesky URI
        if: steps.bluesky.outputs.uri != ''
        run: |
          POST_PATH="_posts/${{ github.event.inputs.post_file }}"
          BLUESKY_URI="${{ steps.bluesky.outputs.uri }}"
          
          # Check if post already has blueskyPostURI (unless force_repost is true)
          if [ "${{ github.event.inputs.force_repost }}" != "true" ] && grep -q "blueskyPostURI:" "$POST_PATH"; then
            echo "Post already has blueskyPostURI and force_repost is false. Updating existing URI."
            # Update existing blueskyPostURI
            sed -i.bak "s|blueskyPostURI:.*|blueskyPostURI: $BLUESKY_URI|" "$POST_PATH"
          else
            # Add new blueskyPostURI to frontmatter
            python3 << 'EOF'
          import os
          import sys
          
          post_path = os.environ['POST_PATH']
          bluesky_uri = os.environ['BLUESKY_URI']
          
          with open(post_path, 'r') as f:
              lines = f.readlines()
          
          # Find the end of frontmatter and insert blueskyPostURI
          in_frontmatter = False
          frontmatter_end = -1
          
          for i, line in enumerate(lines):
              if line.strip() == '---':
                  if not in_frontmatter:
                      in_frontmatter = True
                  else:
                      frontmatter_end = i
                      break
          
          if frontmatter_end > 0:
              # Insert blueskyPostURI before the closing ---
              lines.insert(frontmatter_end, f'blueskyPostURI: {bluesky_uri}\n')
              
              with open(post_path, 'w') as f:
                  f.writelines(lines)
              print(f"Added blueskyPostURI to {post_path}")
          else:
              print("Error: Could not find frontmatter in post")
              sys.exit(1)
          EOF
          fi
          
          echo "Updated $POST_PATH with Bluesky URI: $BLUESKY_URI"
          
          # Commit the change
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add "$POST_PATH"
          git commit -m "Add Bluesky post URI to ${{ github.event.inputs.post_file }}"
          git push
